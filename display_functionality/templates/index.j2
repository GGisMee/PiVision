<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobil Dashboard</title>
    <script src="https://kit.fontawesome.com/70c8e77483.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        var socket = io();
        
        // Listen for updates from the server
        socket.on('update', function(data) {
            document.getElementById("d_front").innerText = data["d_front"];
            document.getElementById("time").innerText = data["time"];
            document.getElementById("num_now").innerText = data["num_now"];
            document.getElementById("d_close").innerText = data["d_close"];
            updateStatus(data.status);
            console.log('Data recieved', data);
        });

        socket.on('log', function(text) {
            console.log(text);
        });

        // Listen for battery status updates
        socket.on('battery_update', function(data) {
            var batteryIcon = document.getElementById("batteryIcon");
            console.log("Battery data recieved ", data.level);

            if (data.level > 75) {
                batteryIcon.classList.add("fa-battery-full");
                batteryIcon.classList.remove("fa-battery-half", "fa-battery-quarter", "fa-battery-empty");
            } else if (data.level > 50) {
                batteryIcon.classList.add("fa-battery-half");
                batteryIcon.classList.remove("fa-battery-full", "fa-battery-quarter", "fa-battery-empty");
            } else if (data.level > 25) {
                batteryIcon.classList.add("fa-battery-quarter");
                batteryIcon.classList.remove("fa-battery-full", "fa-battery-half", "fa-battery-empty");
            } else {
                batteryIcon.classList.add("fa-battery-empty");
                batteryIcon.classList.remove("fa-battery-full", "fa-battery-half", "fa-battery-quarter");
            }
        });

        function updateStatus(status) {
            // Loop through all the indicator boxes
            let color;
            if (status <= 3) {
                    color = '#90ee90'
                } else if (status <= 6) {
                    color = '#f5f575'; 
                } else {
                    color = '#ff5252';
                }
            document.querySelectorAll('.indicator').forEach((box, index) => {
                box.classList.toggle('active', index < status);
            });
        }

        function toggleButton() {
            var button = document.getElementById("toggleButton");
            var currentState = button.getAttribute("data-state");

            if (currentState === "start") {
                button.setAttribute("data-state", "stop");
                button.innerText = "Stop";
                button.style.backgroundColor = "lightcoral";
                sendStateToServer("start");
            } else {
                button.setAttribute("data-state", "start");
                button.innerText = "Start";
                button.style.backgroundColor = "lightgreen";
                sendStateToServer("stop");
            }
        }

        function sendStateToServer(state) {
            fetch('/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: state })
            });
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: "Archivo", sans-serif;
            display: flex; 
            height: 100vh; 
            margin: 0; 
            background-color: #E7E7E7; 
        }
        .container { 
            display: flex; 
            flex: 1;
            gap: 20px;
            padding: 10px;
            box-sizing: border-box;
            align-items: stretch;
        }
        .column { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 

        }
        .side {
            flex:2;
            
        }
        .middle { 
            flex: 4;
        }
        .box { 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #252525;
            color: white;
            padding: 20px;
            border-radius: 20px;
            flex: 1;
            text-align: center;
        }

        .box .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 2em;
        }
        .box .divider {
            width: 100%;
            height: 2px;
            background-color: white;
            margin: 20px 0;
        }
        .box .content {
            font-size: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .box .icon i,
        .box .icon img {
            height: 1em;
            width: auto;
            vertical-align: middle;
        }
        
        
        @media (max-width: 430px) {
            .container { flex-direction: column; gap: 40px; padding: 40px; }
            .box { font-size: 2em; padding: 30px; }
        }

        .sidebar {
            width: 80px;
            background-color: #252525;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .battery-icon {
            padding: 20px;
            font-size: 40px; /* Adjust font size for better visibility */
            width: auto;
            vertical-align: middle;
            margin: 0; /* Remove margin */
            text-align: center; /* Center the icon horizontally */
            align-self: flex-start; /* Align it at the top */
            display: flex;
            justify-content: center; /* Center the icon horizontally */
        }

        #toggleButton {
            width: 70%;  /* Narrow width */
            height: 30%; /* Increased height */
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 30px;  /* Rounded corners */
            cursor: pointer;
            background-color: lightgreen;
            writing-mode: vertical-rl; /* Rotate text */
            text-orientation: mixed;  /* Ensure proper text orientation */
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
            transition: background-color 0.3s ease-in-out, transform 0.1s;
        }

        #sidebar_other_content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #battery_container{
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        /*Indication info*/
        .indication_boxes {
            display: flex;
            gap: 5px;
            width:100%;
        }
        .indicator {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            background-color: rgb(111, 111, 111);
        }
        .indicator.active {
            background-color: #ff5252;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="column side">
            <div class="box">
                <div class="header">
                    <span class="title">Avstånd fram</span>
                    <span class="icon"><i class="fas fa-ruler"></i></span>
                </div>
                <span class="divider"></span>
                <div id="d_front" class="content">{{ data["d_front"] }}{% if data["d_front"] != '-' %} m{% endif %}</div>
            </div>
            <div class="box">
                <div class="header">
                    <span class="title">Avstånd Nära</span>
                    <span class="icon"><i class="fas fa-ruler"></i></span>
                </div>
                <span class="divider"></span>
                <div id="d_close" class="content">{{ data["d_close"]}}{% if data["d_front"] != '-' %} m{% endif %}</div>
            </div>
            
        </div>
        <div class="column middle">
            <div class="box">
                <i class="fa-solid fa-triangle-exclamation"></i>
            
                <div class="indication_boxes">
                    {% for i in range(9) %}
                        <div class="indicator" id="box{{ i }}"></div>
                    {% endfor %}
                </div>
            </div>
            
        </div>
        <div class="column side">
            <div class="box">
                <div class="header">
                    <span class="title">Antal Nu</span>
                    <span class="icon"><img src="{{ url_for('static', filename='cars_icon.png') }}" alt="Cars Icon" width="30"></span>
                </div>
                <span class="divider"></span>
                <div id="num_now" class="content">{{data["num_now"]}}</div>
            </div>
        <div class="box">
            <div class="header">
                <span class="title">Tid</span>
                <span class="icon"><i class="fa-regular fa-clock"></i></span>
            </div>
            <span class="divider"></span>
            <div id="time" class="content">{{ data["time"] }}</div>
        </div>
    </div>
</div>
<div class="sidebar">
    <!-- Battery Icon -->
     <div id="battery_container">
        <div id="batteryIcon" class="battery-icon">
            <i class="fas fa-battery-full"></i> <!-- Default icon -->
        </div>
    </div>
    <div id='sidebar_other_content'>
        <button id="toggleButton" onclick="toggleButton()" data-state="start">Start</button>
    </div>
</div>
<button onclick="updateStatus(8)">Test Indicators</button>

</body>